// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =====================================================
// ENUMS
// =====================================================

// Rol de un usuario
enum UserRole {
  admin
  coordinator
  driver
  collector
  vendor
  viewer
}
// Rol del Staff
enum StaffRole {
  driver
  collector
  mechanic
  supervisor
}
// Estatus del Staff
enum StaffStatus {
  active
  inactive
  vacation
  suspended
}
// Tipo de licencia
enum LicenseType {
  A
  B
  C
  D
  E
}
// Clasificaciones del menu
enum MenuType {
  principal
  operations
  config
}
// Tipos de acciones que se peuden realizar sobre un modulo
enum PermissionAction {
  view      // Ver/Listar
  create    // Crear
  update    // Editar
  delete    // Eliminar
  export    // Exportar datos
  print     // Imprimir
  manage    // Gestión completa (todos los permisos)
}

// =====================================================
// MODELS
// =====================================================

// Tabla de usuarios del sistema
model User {
  id                      String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email                   String    @unique @db.VarChar(255)
  passwordHash            String    @map("password_hash") @db.VarChar(255)
  fullName                String    @map("full_name") @db.VarChar(255)
  role                    UserRole  @default(viewer)
  isActive                Boolean   @default(true) @map("is_active")
  
  // Token de acceso
  refreshTokenHash        String?   @map("refresh_token_hash") @db.VarChar(500)
  refreshTokenCreatedAt   DateTime? @map("refresh_token_created_at") @db.Timestamp()
  refreshTokenExpiresAt   DateTime? @map("refresh_token_expires_at") @db.Timestamp()
  
  // Reinicio de password
  resetToken              String?   @map("reset_token") @db.VarChar(255)
  resetTokenExpiry        DateTime? @map("reset_token_expiry") @db.Timestamp()
  
  // Auditoria
  lastLogin               DateTime? @map("last_login") @db.Timestamp()
  createdAt               DateTime  @default(now()) @map("created_at") @db.Timestamp()
  updatedAt               DateTime  @updatedAt @map("updated_at") @db.Timestamp()

  // Relaciones
  staff                   Staff?
  rolePermissions         RolePermission[]

  @@index([email])
  @@index([role])
  @@index([isActive])
  @@map("users")
}

// Tabla del staff que usaran el sistema
model Staff {
  id                      String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                  String?     @unique @map("user_id") @db.Uuid
  employeeNumber          String      @unique @map("employee_number") @db.VarChar(20)
  fullName                String      @map("full_name") @db.VarChar(255)
  email                   String      @db.VarChar(255)
  role                    StaffRole
  isActive                Boolean     @default(true) @map("is_active")

  // Información general del staff
  status                  StaffStatus @default(active)
  hireDate                DateTime    @map("hire_date") @db.Date
  birthDate               DateTime    @map("birth_date") @db.Date
  phone                   String      @db.VarChar(20)
  address                 String?     @db.Text
  emergencyContact        String?     @map("emergency_contact") @db.VarChar(255)
  emergencyPhone          String?     @map("emergency_phone") @db.VarChar(20)

  // Información si es driver
  licenseNumber           String?      @map("license_number") @db.VarChar(50)
  licenseType             LicenseType? @map("license_type")
  licenseExpiry           DateTime?    @map("license_expiry") @db.Date

  // Auditoria
  createdAt               DateTime     @default(now()) @map("created_at") @db.Timestamp()
  updatedAt               DateTime     @updatedAt @map("updated_at") @db.Timestamp()

  // Relaciones
  user                    User?  @relation(fields: [userId], references: [id])

  @@index([employeeNumber])
  @@index([role])
  @@index([status])
  @@index([userId])
  @@index([licenseExpiry])
  @@index([isActive])
  @@map("staff")
}

// Tabla de módulos en el sistema
model Module {
  id                      String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                    String    @unique @db.VarChar(250)              // Ej: "dashboard", "ticket_sales", "routes"
  displayName             String    @map("display_name") @db.VarChar(250) // Ej: "Dashboard", "Venta de Boletos", "Rutas"
  description             String?   @db.Text
  icon                    String?   @db.VarChar(100)            // Nombre del icono (Opcional)
  order                   Int       @default(0)                 // Orden de visualizacion en el menu
  parentId                String?   @map("parent_id") @db.Uuid  // ID del modulo padre (Opcional)
  menuType                MenuType                              // Tipo de menu Configuracion, Operaciones o Configuración.
  isActive                Boolean   @default(true) @map("is_active")

  // Auditoria
  createdAt               DateTime     @default(now()) @map("created_at") @db.Timestamp()
  updatedAt               DateTime     @updatedAt @map("updated_at") @db.Timestamp()

  // Relaciones
  parent                  Module?      @relation("ModuleHierarchy", fields: [parentId], references: [id])
  children                Module[]     @relation("ModuleHierarchy")
  permissions             Permission[]
  rolePermissions         RolePermission[]

  @@index([name])
  @@index([parentId])
  @@index([isActive])
  @@index([order])
  @@index([menuType])
  @@map("modules")
}

// Tabla de permisos de los modulos
model Permission {
  id                      String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  moduleId                String            @map("module_id") @db.Uuid
  action                  PermissionAction
  description             String?           @db.Text
  isActive                Boolean           @default(true) @map("is_active")

  // Auditoria
  createdAt               DateTime          @default(now()) @map("created_at") @db.Timestamp()
  updatedAt               DateTime          @updatedAt @map("updated_at") @db.Timestamp()

  // Relaciones
  module                  Module            @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  rolePermissions         RolePermission[]

  @@unique([moduleId, action]) // Un modulo no puede tener la misma acción duplicada
  @@index([moduleId])
  @@index([action])
  @@index([isActive])
  @@map("permissions")
}

// Tabla intermedia: Relacion de roles de usuario con permisos
model RolePermission {
  id                      String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                  String?           @map("user_id") @db.Uuid          // Si es null, aplica al rol en general
  userRole                UserRole?         @map("user_role")                 // admin, coordinator, driver, etc.
  moduleId                String            @map("module_id") @db.Uuid  
  permissionId            String            @map("permission_id") @db.Uuid
  granted                 Boolean           @default(true)                    // true = permitido, false = denegado

  // Auditoria
  createdAt               DateTime          @default(now()) @map("created_at") @db.Timestamp()
  updatedAt               DateTime          @updatedAt @map("updated_at") @db.Timestamp()

  // Relaciones
  user                    User?             @relation(fields: [userId], references: [id], onDelete: Cascade)
  module                  Module            @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  permission              Permission        @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleId, permissionId])      // Permiso específico por usuario
  @@unique([userRole, moduleId, permissionId])    // Permiso por rol
  @@index([userId])
  @@index([userRole])
  @@index([moduleId])
  @@index([permissionId])
  @@index([granted])
  @@map("role_permissions")
}